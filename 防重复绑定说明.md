# 防重复绑定机制说明

## 🔒 核心规则

**每个钱包地址只能绑定一次，绑定后无法更改或重复绑定。**

## 🛡️ 防重复机制

### 1. 数据库层面
- 钱包地址设置为 `UNIQUE` 约束
- 使用 `ON CONFLICT DO NOTHING` 防止重复插入
- 数据库自动拒绝重复的钱包地址

```sql
CREATE TABLE users (
  wallet_address TEXT UNIQUE NOT NULL,
  ...
)
```

### 2. 后端API层面
- 绑定前检查钱包地址是否已存在
- 返回明确的错误信息
- 记录绑定状态

```javascript
if (data.success) {
  // 绑定成功
} else if (data.alreadyBound) {
  // 已经绑定过
}
```

### 3. 前端UI层面
- 连接钱包后自动检查绑定状态
- 已绑定用户不显示"确认绑定"按钮
- 显示明显的警告提示
- 展示当前绑定信息

## 📱 用户体验流程

### 情况1: 新用户首次绑定

```
1. 访问推荐链接 → 显示团队信息
2. 连接钱包 → 检查绑定状态
3. 未绑定 → 显示"确认绑定"按钮
4. 点击确认 → 绑定成功
5. 显示绑定信息和推荐链接
```

### 情况2: 已绑定用户再次访问

```
1. 访问任意链接
2. 连接钱包 → 检查绑定状态
3. 已绑定 → 不显示"确认绑定"按钮
4. 显示黄色警告: "该钱包地址已绑定"
5. 显示当前绑定的团队信息
6. 显示个人推荐链接
```

## 🎨 界面提示

### 已绑定警告框
```
⚠️ 该钱包地址已绑定
每个钱包地址只能绑定一次，无法重复绑定或更改团队
```

### 绑定信息展示
```
✓ 绑定信息
━━━━━━━━━━━━━━━
所属团队: 张三团队
推荐人: 张三团队
        0x1234...5678
```

## 🔐 安全特性

1. **唯一性保证**: 数据库UNIQUE约束确保一个钱包只能有一条记录
2. **前端验证**: 连接钱包后立即检查绑定状态
3. **后端验证**: API层面双重检查
4. **用户提示**: 清晰的UI提示防止用户困惑

## 💡 常见问题

### Q: 用户想更换团队怎么办？
A: 系统不支持更换团队。每个钱包地址只能绑定一次，这是为了：
- 防止刷单行为
- 保证推荐关系的真实性
- 简化系统逻辑

### Q: 用户误绑定了怎么办？
A: 需要管理员在数据库中手动删除该记录：
```sql
DELETE FROM users WHERE wallet_address = '0x...';
```

### Q: 如何验证系统是否防止重复绑定？
A: 测试步骤：
1. 使用同一钱包地址绑定一次
2. 刷新页面重新连接钱包
3. 应该看到"已绑定"警告，无"确认绑定"按钮

## 📊 数据完整性

系统确保：
- ✅ 一个钱包地址 = 一条用户记录
- ✅ 一个用户 = 一个推荐人
- ✅ 一个用户 = 一个团队
- ✅ 推荐关系不可更改
- ✅ 统计数据准确可靠

## 🔄 绑定流程图

```
┌─────────────┐
│  访问链接    │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  连接钱包    │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 检查绑定状态 │
└──────┬──────┘
       │
   ┌───┴───┐
   │       │
已绑定   未绑定
   │       │
   ▼       ▼
显示警告  显示绑定按钮
显示信息  等待确认
   │       │
   │       ▼
   │    点击确认
   │       │
   │       ▼
   │    绑定成功
   │       │
   └───┬───┘
       │
       ▼
   显示推荐链接
   显示团队成员
```

## 🎯 总结

防重复绑定机制通过**数据库约束 + 后端验证 + 前端UI控制**三层防护，确保：
- 每个钱包地址只能绑定一次
- 用户清楚了解绑定状态
- 系统数据准确可靠
- 防止恶意刷单行为
