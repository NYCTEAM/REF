<!DOCTYPE html>
<html>
<head>
    <title>æ•°æ®åº“æ£€æŸ¥</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #0f0; }
        button { padding: 10px 20px; margin: 10px; font-size: 16px; cursor: pointer; }
        pre { background: #000; padding: 15px; overflow: auto; max-height: 600px; }
        .success { color: #0f0; }
        .error { color: #f00; }
        .warning { color: #ff0; }
    </style>
</head>
<body>
    <h1>ğŸ” æ•°æ®åº“æ£€æŸ¥å·¥å…·</h1>
    
    <button onclick="checkDatabase()">æ£€æŸ¥æ•°æ®åº“</button>
    <button onclick="resyncAll()">é‡æ–°åŒæ­¥æ‰€æœ‰ç”¨æˆ·</button>
    <button onclick="scanAllUsers()">ğŸ”„ æ‰«ææ‰€æœ‰ç”¨æˆ·æ–° NFT</button>
    
    <div id="result"></div>

    <script>
        async function checkDatabase() {
            const result = document.getElementById('result');
            result.innerHTML = '<p>â³ æ£€æŸ¥ä¸­...</p>';
            
            try {
                const res = await fetch('/api/admin/check-database');
                const data = await res.json();
                
                if (data.success) {
                    let html = '<h2 class="success">âœ… æ£€æŸ¥å®Œæˆ</h2>';
                    
                    data.report.checks.forEach(check => {
                        html += `<h3>${check.name} - ${check.summary}</h3>`;
                        html += `<pre>${JSON.stringify(check.data, null, 2)}</pre>`;
                    });
                    
                    result.innerHTML = html;
                } else {
                    result.innerHTML = `<p class="error">âŒ æ£€æŸ¥å¤±è´¥: ${data.message}</p>`;
                }
            } catch (error) {
                result.innerHTML = `<p class="error">âŒ é”™è¯¯: ${error.message}</p>`;
            }
        }
        
        async function resyncAll() {
            if (!confirm('ç¡®å®šè¦é‡æ–°åŒæ­¥æ‰€æœ‰ç”¨æˆ·çš„ NFT æ•°æ®å—ï¼Ÿ')) {
                return;
            }
            
            const result = document.getElementById('result');
            result.innerHTML = '<p>â³ åŒæ­¥ä¸­...</p>';
            
            try {
                const res = await fetch('/api/admin/resync-all', { method: 'POST' });
                const data = await res.json();
                
                if (data.success) {
                    let html = `<h2 class="success">âœ… ${data.message}</h2>`;
                    html += `<p>æ€»ç”¨æˆ·æ•°: ${data.total_users}</p>`;
                    html += `<p>æ›´æ–°æ•°: ${data.updated_count}</p>`;
                    html += `<pre>${JSON.stringify(data.results, null, 2)}</pre>`;
                    
                    result.innerHTML = html;
                } else {
                    result.innerHTML = `<p class="error">âŒ åŒæ­¥å¤±è´¥: ${data.message}</p>`;
                }
            } catch (error) {
                result.innerHTML = `<p class="error">âŒ é”™è¯¯: ${error.message}</p>`;
            }
        }
        
        async function scanAllUsers() {
            if (!confirm('ç¡®å®šè¦æ‰«ææ‰€æœ‰ç”¨æˆ·çš„æ–° NFT å—ï¼Ÿè¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿã€‚')) {
                return;
            }
            
            const result = document.getElementById('result');
            result.innerHTML = '<p>â³ æ‰«æä¸­ï¼Œè¯·ç¨å€™...</p>';
            
            try {
                const res = await fetch('/api/admin/scan-all-users', { method: 'POST' });
                const data = await res.json();
                
                if (data.success) {
                    let html = `<h2 class="success">âœ… ${data.message}</h2>`;
                    html += `<h3>æ‰«æç»Ÿè®¡</h3>`;
                    html += `<p>æ€»ç”¨æˆ·æ•°: ${data.results.total}</p>`;
                    html += `<p>å·²æ‰«æ: ${data.results.scanned}</p>`;
                    html += `<p>å·²è·³è¿‡: ${data.results.skipped}</p>`;
                    html += `<p>å·²æ›´æ–°: ${data.results.updated}</p>`;
                    html += `<p>é”™è¯¯æ•°: ${data.results.errors}</p>`;
                    html += `<p class="success">æ–°å¢ NFT æ€»æ•°: ${data.results.newNFTsTotal}</p>`;
                    
                    if (data.results.details.length > 0) {
                        html += `<h3>æ›´æ–°è¯¦æƒ…</h3>`;
                        html += `<pre>${JSON.stringify(data.results.details, null, 2)}</pre>`;
                    }
                    
                    result.innerHTML = html;
                } else {
                    result.innerHTML = `<p class="error">âŒ æ‰«æå¤±è´¥: ${data.message}</p>`;
                }
            } catch (error) {
                result.innerHTML = `<p class="error">âŒ é”™è¯¯: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>
